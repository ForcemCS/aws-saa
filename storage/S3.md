## Simple Storage Service (S3)

<img src="C:\Users\ForceCS\Desktop\aws-saa\storage\img\1740109020829.png" alt="1740109020829" style="zoom:50%;" />

可以与IAM策略和角色很好的集成在一起

S3 也可以通过控制台、CLI、SDK 以及 REST API 进行访问

### 使用案例

<img src="./img/1740109794650.png" alt="1740109794650" style="zoom:50%;" />

首先，你会有一个网络服务器坐落在某个数据中心。你的网页所有相关文件都会在那个 web 服务器上。有几种不同的文件，但主要会有一个 HTML 文件，对吧？所以当你在网络浏览器中请求一个网站时，它实际上是是在访问一个 web 服务器并请求一个 HTML 文件，然后将其渲染到你的屏幕上。你还会有几个其他文件，比如 CSS 和 JavaScript 文件。但除此之外，你还需要存储与该网站相关的所有媒体。这些包括网站上的图片、任何音乐或视频，以及你的站点可能需要使用的视频。

现在，当你向网站发送请求时，发生的事件是那个 web server 会把网站的 HTML 发回来，对吧？那将包含这个网站的所有结构。这个 HTML文件将会包含一个链接，，指向它需要的所有图片和视频以方便渲染。这些链接将会指向在网络服务器上存储的资源。所以接下来你作为用户会向网络服务器发送请求，获取这些图片和视频。这个就是传统网站的工作方式。

这个设定的问题是，想象一下如果这是一个像 YouTube 或 Netflix 这样的站点，他们的服务器上存储着越来越大的视频对吧？在你的网络服务器上存储视频是非常昂贵的。而且要记住，你可能有一台网络服务器，而你实际上可以扩展到全球分布的数十个网络服务器。如果你有数个服务器，每一个服务器都需要存储 Netflix 或 YouTube 这样的视观。而这个只是一个非常高昂的扩展方案。这就是传统设置的问题

### 名词解释

<img src="./img/1740109997209.png" alt="1740109997209" style="zoom:50%;" />

### Demo

1. bucket name
2. 选择region
3. 复制已经存在的bucket（可选）
4. 默认情况下是私有的，只有创建者的账号才可以访问

### Storage Classes

<img src="C:\Users\ForceCS\Desktop\aws-saa\storage\img\1740216470925.png" alt="1740216470925" style="zoom:50%;" />

+ standard(default)

  频繁访问的数据，出站流量收费

+ standard-IA

  不需要频繁访问的数据，除了出站费用，会有一个检索费用，而且不是一堆小文件，比默认的存储类别更好

+ One-Zone-IA

  几乎与standard-IA相同，就是单可用区的

+ Glacier-Instant

  很少访问的归档数据，检索数在毫秒内完成，检索费用高，90天的数据

+ Glacier-flexible

  当我们请求一个数据时，不能立即在毫秒内响应，

+ Glacier Deep Archive

  不能被公开访问，最便宜的存储类

+ Intelligent-Tiering

  如果你不知道使用哪种存储类别，可以选择

  但是需要支付监控自动化费用

存储类别在上传时通过设置 x-amz-storage-class 请求头进行设置，但也可在上传后更改。

### Versioning

<img src="./img/1740365405791.png" alt="1740365405791" style="zoom:50%;" />

一旦启用了版本控制，你永远不能禁用它，只能暂停它

上边的三个版本都需要你为其付费

#### Multi-Factor Authentication (MFA) Delete

+ When the feature is enabled, MFA is required to change the versioning state of the bucket.
+ MFA is required to delete versions and can only be enabled using CLI.

### ACL and Resource Policies

<img src="./img/1740369374480.png" alt="1740369374480" style="zoom:50%;" />

我们接下来将讨论桶策略（谁可以访问这个bucket，以及可以做哪些操作）

```json
{  
  "Version": "2012-10-17",  
  "Statement": [  
    {  
      "Sid": "AllowRule",  
      "Principal": {  
        "AWS": [  
          "arn:aws:iam::111122223333:user/JohnDoe"  
        ]  
      },  
      "Effect": "Allow",  
      "Action": ["s3:GetObject"],  
      "Resource": ["arn:aws:s3:::DOC-EXAMPLE-BUCKET/*"]  
    }  
  ]  
}
```

+ Sid为规则起一个名字
+ Principal策略适用于谁
+ Effect是允许还是拒绝

```json
{  
  "Id": "PolicyId2",  
  "Version": "2012-10-17",  
  "Statement": [  
    {  
      "Sid": "AllowIP",  
      "Effect": "Allow",  
      "Principal": "*",  
      "Action": "s3:*",  
      "Resource": [  
        "arn:aws:s3:::DOC-EXAMPLE-BUCKET",  
        "arn:aws:s3:::DOC-EXAMPLE-BUCKET1/*"  
      ],  
      "Condition": {  
        "IpAddress": {  
          "aws:SourceIp": [  
            "192.0.2.0/24"  
          ]  
        }  
      }  
    }  
  ]  
}
```

#### Demo1

+ 账号1 用户1执行操作

  1. 按照默认的方式创建一个bucket

  2. 上传文件（验证open选项）

     1. 现在切换到同一个账号1的另一个用户2(IAM如下)

     ```json
     {  
       "Version": "2012-10-17",  
       "Statement": [  
         {  
           "Sid": "VisualEditor0",  
           "Effect": "Allow",  
           "Action": [  
             "s3:ListAllMyBuckets",  
             "s3:ListBucket"  
           ],  
           "Resource": "*"  
         }  
       ]  
     }
     ```

     2. open选项内容是无法查看的

+ 回到用户1，创建存储桶策略

  用户1和用户2的账号ID是相同的841806927337

  <img src="./img/1740383885909.png" alt="1740383885909" style="zoom:50%;" />

  ```json
  {  
    "Version": "2012-10-17",  
    "Statement": [  
      {  
        "Sid": "user2AllowLogs",  
        "Principal": {  
          "AWS": "arn:aws:iam::841806927337:user/user2"  
        },  
        "Effect": "Allow",
        ## 可以搜索 AWS  S3 API Reference
        "Action": ["s3:GetObject"],  
        "Resource": [
            "arn:aws:s3:::my-loki-s3/helm/*"
        ]  
      }  
    ]  
  }
  ```

+ 切回到用户2 ，可以执行open

+ **需要注意的是，如果允许匿名用户访问，需要关闭默认选项**

  <img src="./img/1740384946237.png" alt="1740384946237" style="zoom:50%;" />

#### Demo2

+ 现在到另一个账号下，执行aws s3 ls s3:// <example bucket>

+ 切换回存储桶的创建用户（账号1用户1）

+ 创建策略

  aws s3 rm s3:// <example bucket>/media/xx.txt

  ```json
  {  
    "Sid": "AllowAccount2UserAdmin",  
    "Principal": {  
      "AWS": "arn:aws:iam::840497317401:user/admin"  
    },  
    "Effect": "Allow",  
    "Action": [  
      "s3:ListBucket",  
      "s3:DeleteObject"  
    ],  
    "Resource": [  
      "arn:aws:s3:::kk-resource-policies",  
      "arn:aws:s3:::kk-resource-policies/media"  
    ]  
  }
  
  ```

