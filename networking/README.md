### Subnets

<img src="./img/1.png" alt="1" style="zoom:50%;" />

VPC 中的子网必须在 CIDR 范围内。

子网块大小必须在 /16 和 /28 之间。

The first 4 IP addresses of a subnet are reserved and cannot be used:

- 192.168.10.0 (Network address)
- 192.168.10.1 – 192.168.10.3 (for AWS)
  - 192.168.10.1 (VPC Router)
  - 192.168.10.2 (DNS)
  - 192.168.10.3 (For Future Use)

The last IP address of a subnet (192.168.10.255) is reserved as the broadcast address.

### Routing

目的是在子网之间路由流量

每个subnet都与一个route table相关联。创建一个新的vpc的时候，会生成一个默认的路由表

多个子网可以与一个路由表相关联

### Internet Gateway

要把子网变成public的第一件事就是要创建一个 Internet Gateway。将其附加到我们的 VPC 上。一旦它附加到 VPC 上，就需要创建一个自定义路由表。在这个路由表中，我们需要配置一个指向 Internet Gateway 的默认路由。这默认路由基本上是说，如果一个数据包进来并且没有匹配任何其他路由，它会自动匹配默认路由，把它发送到 Internet Gateway。因为如果它不匹配任何更具体的路由，这意味着它可能是要去互联网。

### Nat Gateway

![1738918336255](./img/1738918336255.png)

假设我们在一个私有网络中有一台服务器。我们需要为这个服务器提供互联网访问权限，这样它才能连接互联网并安全补丁。
现在我们可以做的是，我们可以将一个互联网网关附加到 VPC。然后，创建一条路由，让这条线路指向互联网网关，然后将这个网络变成公共网络，这样它就可以访问互联网，以下载任何需要的更新和安全补丁。

现在的问题是，服务器是一个内部服务器，只允许内部团队访问，我们该怎么办？我们不希望它对互联网开放。因此我们希望服务器能够自动发起与互联网的连接。
但是互联网网关永远不应该连接到我们的服务器。我们应该如何解决这个问题?要实际使用 NAT Gateway，你仍然需要一个 Internet Gateway。
所以要让 NAT Gateway 正常运行，您首先需要配置一个 Internet Gateway 并将其附加到您的 VPC，然后后续需要创建一个公共子网，并设置必要的路由指向互联网网关。

<img src="./img/1738918613159.png" alt="1738918613159" style="zoom:50%;" />

NAT Gateway是不具备弹性的，我们是将他部署在一个公有子网中，所以它特定于一个可用区，可以通过多可用区部署，实现冗余

#### demo

1. 创建vpc

2. 创建私有子网

3. 创建ec2实例（属于上边的私有子网，并且不分配公网IP）

4. 创建igw, Attach to vpc

5. 创建公共子网

6. 创建两个路由表（私有，公有）

   + 在公有路由表中定义一条路由

     <img src="./img/1738920561381.png" alt="1738920561381" style="zoom:50%;" />

   + 将公有子网与这个路由表相关联

     <img src="./img/1738920741283.png" alt="1738920741283" style="zoom:50%;" />

   + 对私有路由表做同样的关联（关联到私有子网）

7. 在公共子网上部署Nat  Gateway

   <img src="./img/1738921174831.png" alt="1738921127301" style="zoom:50%;" />

8. 然后我们去私有路由表，增加一条路由信息

   <img src="./img/1738921327608.png" alt="1738921327608" style="zoom:50%;" />

### DNS In Vpc

<img src="./img/1738994522758.png" alt="1738994522758" style="zoom:50%;" />

当你创建一个自定义 VPC 时，有两个选项会影响 DNS 的工作方式。默认情况下，只有私有 IP 会带有 DNS 记录，而公共 IP 则不会。如果你希望公共 IP 地址能够获得域名，你需要确保创建 VPC 时启用 DNS 主机名称。
这个属性的默认值是 false，除非 VPC 是默认 VPC。然后，为了实现在 VPC 中使用 DNS 解析，你可以使用 AWS DNS 服务。我们必须确保 DNS 支持选项。

启用 DNS 主机名称选择 VPC 是否支持为公共 IP 地址的实例分配 DNS 主机名。启用 DNS 支持选项决定了 VPC 是否支持通过 Amazon 提供的 DNS 服务器进行 DNS 解析。所以，如果启用 DNS 支持选项没有开启，那么你将不能使用 AWS 提供的域名进行通信。

假设我们之前的VPC中有一台ec2,但是没有公网DNS，我们编辑vpc,启用DNS 主机名就会获得DNS地址

### Elastic IP

固定的IP地址分配给账号，这个IP地址会被保留，不至于随着实例的重启或销毁而丢失。

同时最酷的地方是可以单独的分配安全组

![1738995776082](./img/1738995776082.png)

EIP是regison性的

### Security Groups &amp; NACLs

#### Stateless firewalls

<img src="./img/1738997011038.png" alt="1738997011038" style="zoom:50%;" />

用户想访问web的443端口，所以必须放行，返回给用户的数据，端口是随机的，所以出站的端口范围是1024-65535

##### NACL

<img src="./img/1738997879097.png" alt="1738997879097" style="zoom:50%;" />

假设我们的EC2关联的安全组（入站和出站都是ALL 放行），现在在子网级别操作NACL

我们可以使用先安全添加，再删除的方式做到精细的控制

#### stateful firewalls

对于出站规则，允许所有的流量到临时的端口，但是有状态防火墙的特点是，足够智能，能知道请求和响应是一组的，实际上是跟踪TCP会话。也就是说我们只是配置入栈规则就可以，出站规则会自动添加（只添加入站的443）

对于更新服务器来说，我们的出站规则是80，入站也会智能的添加

##### 安全组

<img src="./img/1738998031336.png" alt="1738998031336" style="zoom:50%;" />

**特别说明：**假设我们有一个关于数据库的安全组，我们希望web服务器，可以访问（假设这个web服务器关联的安全组是http-sg）,那么我们设置数据库的安全组时，就可以选择source为http-sg,这样我们不用每次修改web服务器的IP

### Load Balancers

<img src="./img/1739006519725.png" alt="1739006519725" style="zoom:50%;" />

会在每个zone中生成一个物理资源LB，在VPC边缘的ELB中会创建一个DNS记录。

必须将LB部署在子网中

#### Classic Load Balancer

不建议使用

#### Application Load Balancer

<img src="./img/1739003980233.png" alt="1739003980233" style="zoom:50%;" />

<img src="./img/1739004135977.png" alt="1739004135977" style="zoom:50%;" />

对于ALB与应用程序之间可以使用明文，因为是在AWS内部的。但是也可以自行管理他们之间的证书

#### Network Load Balancer

NLB会将TCP连接转发到你的EC2实例，所以在你的NLB没有任何的终止，而是客户端直接与ec2建立连接

<img src="./img/1739004709503.png" alt="1739004709503" style="zoom:50%;" />

#### 跨可用区负载均衡

![1739007438742](./img/1739007438742.png)

#### 部署模式

部署在公有子网或者私有子网中

#### 监听器和目标组

<img src="./img/1739010137385.png" alt="1739010137385" style="zoom:50%;" />

#### Demo

+ 在两个不同的可用区中创建EC2实例，属于公有子网（101/24，102/24）
+ 为两个负载均衡器创建两个公有子网（属于和上边一样的可用区）
+ 去EC2的页面，部署LB
  + 选择之前创建的lb公有子网
  + 配置监听器和目标组